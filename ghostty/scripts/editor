#!/usr/bin/env bash
set -euo pipefail

# Usage: ghostty-3pane-inner [start-dir]
START_DIR="${1:-$HOME}"
cd "$START_DIR"

# Optional per-pane commands (export these before launching if you want)
LEFT_CMD=${LEFT_CMD:-"gemini"}
RIGHT_TOP_CMD=${RIGHT_TOP_CMD:-""}
RIGHT_BOTTOM_CMD=${RIGHT_BOTTOM_CMD:-""}

# ---- Build layout in THIS window using your leader keys ----
/usr/bin/osascript <<'APPLES'
on tapLeader(letter)
  tell application "System Events"
    keystroke "d" using {command down} -- your leader: cmd+d>
    delay 0.03
    if letter is "\\" then
      keystroke "\\"
    else
      keystroke letter
    end if
    delay 0.03
  end tell
end tapLeader

on pressN(keycode_, mods_, n_)
  tell application "System Events"
    repeat n_ times
      key code keycode_ using mods_
      delay 0.02
    end repeat
  end tell
end pressN

on typeAndEnter(cmdText)
  tell application "System Events"
    keystroke (cmdText as string)
	keystroke return
  end tell
end typeAndEnter

tell application "System Events"
  tell application process "Ghostty"
    set frontmost to true

    -- splits per your config
    my tapLeader("\\")   -- cmd+d>\  -> new_split:right
    my tapLeader("l")    -- cmd+d>l  -> goto_split:right
    my tapLeader("-")    -- cmd+d>-  -> new_split:down

    -- equalize first (optional, keeps results consistent)
    my tapLeader("e")    -- cmd+d>e  -> equalize_splits

    -- make LEFT ≈ 35%  (focus RIGHT and grow it leftwards)
    my tapLeader("l")    -- focus right column
    my pressN(123, {control down, option down}, 14) -- ctrl+opt+Left ×14

    -- make RIGHT-TOP ≈ 70%  (focus top-right and grow downward)
    my tapLeader("k")    -- focus right-top
    my pressN(125, {control down, option down}, 6) -- ctrl+opt+Down ×6

	-- move to LEFT and run gemini
	my tapLeader("h")
	my typeAndEnter("gemini")

  end tell
end tell
APPLES

# ---- (Optional) run commands in panes by typing them + Enter ----
run_in_pane() { # $1 = focus steps via your leader (h/j/k/l), $2 = command
  local moves="$1" cmd="$2"; [[ -z "$cmd" ]] && return 0
  /usr/bin/osascript <<APPLES
tell application "System Events"
  tell application process "Ghostty"
    set frontmost to true
    $(
      IFS=' '
      for m in $moves; do
        echo 'keystroke "d" using {command down}'
        echo 'delay 0.03'
        case "$m" in
          h) echo 'keystroke "h"';;
          j) echo 'keystroke "j"';;
          k) echo 'keystroke "k"';;
          l) echo 'keystroke "l"';;
        esac
        echo 'delay 0.03'
      done
    )
    keystroke "$(printf '%s' "$cmd" | sed 's/\\/\\\\/g; s/"/\\"/g')"
    key code 36 -- Enter
  end tell
end tell
APPLES
}

# After layout, focus is on right-top.
#run_in_pane "h" "${LEFT_CMD}"         # left pane
#run_in_pane ""  "${RIGHT_TOP_CMD}"    # right-top
#run_in_pane "j" "${RIGHT_BOTTOM_CMD}" # right-bottom

